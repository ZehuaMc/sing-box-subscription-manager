<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ğŸš€ Sing-Box é…ç½®ç®¡ç†å¹³å° ğŸš€</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- CodeMirror CSS å’Œ JS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/codemirror.min.css">
  <!-- å¼•å…¥ material-darker ä¸»é¢˜ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/theme/material-darker.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/mode/javascript/javascript.min.js"></script>
  <!-- CodeMirror runMode addon for syntax highlighting in static mode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/addon/runmode/runmode.min.js"></script>
  <!-- è‡ªå®šä¹‰ CSS ç¾åŒ–é¡µé¢ -->
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: #f0f2f5;
      color: #333;
    }
    header {
      background: linear-gradient(90deg, #4CAF50, #66BB6A);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    header h1 {
      margin: 0;
      font-size: 2em;
    }
    .container {
      max-width: 1200px;
      margin: 30px auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .hidden {
      display: none;
    }
    .tabs {
      display: flex;
      border-bottom: 2px solid #ccc;
      margin-bottom: 20px;
    }
    .tab {
      padding: 12px 24px;
      cursor: pointer;
      background: #e0e0e0;
      margin-right: 2px;
      border-top-left-radius: 5px;
      border-top-right-radius: 5px;
      transition: background 0.3s;
    }
    .tab:hover {
      background: #d5d5d5;
    }
    .tab.active {
      background: white;
      border: 2px solid #ccc;
      border-bottom: none;
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    .btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px 0;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.3s;
      font-size: 1em;
    }
    .btn:hover {
      background: #45a049;
    }
    input[type="text"], input[type="password"], textarea, select {
      padding: 10px;
      width: 100%;
      box-sizing: border-box;
      margin: 5px 0 15px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
    }
    textarea {
      resize: vertical;
      min-height: 150px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 12px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    pre {
      margin: 0;
      font-family: "Courier New", Courier, monospace;
      font-size: 0.95em;
    }
    .raw-link {
      font-size: 1.1em;
      margin-top: 10px;
      background: #f9f9f9;
      padding: 10px;
      border: 1px dashed #ccc;
      word-break: break-all;
      border-radius: 4px;
    }
    /* è®¾ç½® CodeMirror ç¼–è¾‘å™¨é«˜åº¦ */
    .CodeMirror {
      height: 500px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸš€ Sing-Box é…ç½®ç®¡ç†å¹³å° ğŸš€</h1>
  </header>
  <div class="container">
    <!-- ç™»å½•åŒºåŸŸ -->
    <div id="login-section">
      <h2>ğŸ”’ è¯·ç™»å½•</h2>
      <input type="password" id="login-password" placeholder="è¯·è¾“å…¥ç™»å½•å¯†ç ">
      <button class="btn" onclick="login()">ç™»å½•</button>
    </div>
    <!-- ä¸»ç®¡ç†åŒºåŸŸ -->
    <div id="main-section" class="hidden">
      <!-- æ ‡ç­¾å¯¼èˆª -->
      <div class="tabs">
        <div class="tab active" data-tab="config">ğŸ“ é…ç½®ç¼–è¾‘</div>
        <div class="tab" data-tab="endpoints">ğŸ”Œ Endpoints ç®¡ç†</div>
        <div class="tab" data-tab="history">ğŸ“œ å†å²ç‰ˆæœ¬ç®¡ç†</div>
      </div>
      <!-- å„æ ‡ç­¾å¯¹åº”çš„å†…å®¹åŒºåŸŸ -->
      <div id="config" class="section active">
        <h2>ğŸ“ é…ç½®ç¼–è¾‘</h2>
        <!-- é…ç½®ç¼–è¾‘åŒºåŸŸä½¿ç”¨ CodeMirror ç¼–è¾‘å™¨ï¼Œæ”¯æŒæ ¼å¼åŒ– -->
        <textarea id="config-editor" placeholder="åŠ è½½é…ç½®ä¸­..."></textarea>
        <div style="margin-bottom: 10px;">
          <button class="btn" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
          <button class="btn" onclick="formatConfig()">ğŸ”§ æ ¼å¼åŒ– JSON</button>
        </div>
        <input type="file" id="upload-config" accept=".json">
        <button class="btn" onclick="uploadConfig()">ğŸ“¤ ä¸Šä¼ é…ç½®æ–‡ä»¶</button>
        <hr>
        <h3>ğŸ”— Raw é“¾æ¥ç”Ÿæˆ</h3>
        <p>è¯·è¾“å…¥ Raw è®¿é—®å¯†ç ï¼š</p>
        <input type="password" id="raw-password" placeholder="Rawè®¿é—®å¯†ç ">
        <p>é€‰æ‹© Endpointsï¼ˆå¯é€‰ï¼‰ï¼š</p>
        <select id="raw-endpoint">
          <option value="">ä¸æ›¿æ¢</option>
        </select>
        <button class="btn" onclick="generateRawLink()">ç”Ÿæˆ Raw é“¾æ¥</button>
        <div id="raw-link-display" class="raw-link"></div>
      </div>
      <div id="endpoints" class="section">
        <h2>ğŸ”Œ Endpoints ç®¡ç†</h2>
        <button class="btn" onclick="loadEndpoints()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
        <table id="endpoints-table">
          <thead>
            <tr>
              <th>Key</th>
              <th>é…ç½®å†…å®¹</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            <!-- ç”± JS åŠ¨æ€ç”Ÿæˆåˆ—è¡¨ -->
          </tbody>
        </table>
        <hr>
        <h3>â• æ·»åŠ  / ä¿®æ”¹ Endpoints</h3>
        <p>Key: <input type="text" id="endpoint-key" placeholder="ä¾‹å¦‚ï¼šdefault"></p>
        <p>Endpoints JSON å†…å®¹:</p>
        <textarea id="endpoint-content" placeholder='ä¾‹å¦‚: [{"type": "wireguard", ...}]'></textarea>
        <button class="btn" onclick="saveEndpoint()">ğŸ’¾ ä¿å­˜ Endpoints</button>
        <button class="btn" onclick="clearEndpointForm()">ğŸ§¹ æ¸…ç©º</button>
      </div>
      <div id="history" class="section">
        <h2>ğŸ“œ å†å²ç‰ˆæœ¬ç®¡ç†</h2>
        <button class="btn" onclick="loadHistory()">ğŸ”„ åˆ·æ–°å†å²åˆ—è¡¨</button>
        <table id="history-table">
          <thead>
            <tr>
              <th>æ–‡ä»¶å</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            <!-- ç”± JS åŠ¨æ€ç”Ÿæˆå†å²ç‰ˆæœ¬åˆ—è¡¨ -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- CodeMirror ä¸å„åŠŸèƒ½ JS è„šæœ¬ -->
  <script>
    let editor;
    let currentConfig = "";
    // åˆ‡æ¢æ ‡ç­¾é¡µæ—¶ï¼Œæ ¹æ® tabId åˆ‡æ¢å†…å®¹ï¼ŒåŒæ—¶è‹¥åˆ‡æ¢åˆ° endpoints æ ‡ç­¾åˆ™è‡ªåŠ¨åŠ è½½ endpoints åˆ—è¡¨ï¼Œ
    // åˆ‡æ¢åˆ°é…ç½®ç¼–è¾‘æ ‡ç­¾æ—¶åˆ™åŠ è½½ Raw ä¸‹æ‹‰èœå•ï¼ˆEndpointsåˆ—è¡¨ï¼‰ï¼Œåˆ‡æ¢åˆ°å†å²ç‰ˆæœ¬ç®¡ç†åˆ™è‡ªåŠ¨åŠ è½½å†å²æ–‡ä»¶ã€‚
    function switchTab(tabId) {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');
      if (tabId === "endpoints") {
        loadEndpoints();
      } else if (tabId === "config") {
        loadRawEndpoints();
      } else if (tabId === "history") {
        loadHistory();
      }
    }

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        switchTab(this.getAttribute('data-tab'));
      });
    });

    function login() {
      const password = document.getElementById("login-password").value;
      fetch('login.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({password: password})
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          document.getElementById("login-section").classList.add('hidden');
          document.getElementById("main-section").classList.remove('hidden');
          loadConfig();
          loadRawEndpoints();
        } else {
          alert("âŒ ç™»å½•å¤±è´¥ï¼Œå¯†ç é”™è¯¯ã€‚");
        }
      })
      .catch(err => console.error("ç™»å½•é”™è¯¯:", err));
    }

    function loadConfig() {
      fetch('get_config.php')
      .then(response => response.json())
      .then(data => {
        currentConfig = JSON.stringify(data, null, 4);
        if (!editor) {
          const textarea = document.getElementById("config-editor");
          textarea.value = currentConfig;
          editor = CodeMirror.fromTextArea(textarea, {
            mode: 'application/json',
            lineNumbers: true,
            matchBrackets: true,
            theme: 'material-darker',
            tabSize: 2,
            lineWrapping: true,
            viewportMargin: Infinity
          });
        } else {
          editor.setValue(currentConfig);
        }
      })
      .catch(err => console.error("åŠ è½½é…ç½®é”™è¯¯:", err));
    }

    function saveConfig() {
      let configData = editor.getValue();
      try {
        JSON.parse(configData);
      } catch(e) {
        alert("âŒ é…ç½®å†…å®¹ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼");
        return;
      }
      fetch('save_json.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({json: configData})
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          alert("âœ… é…ç½®ä¿å­˜æˆåŠŸï¼");
          loadConfig();
        } else {
          alert("âŒ ä¿å­˜å¤±è´¥ï¼š" + data.error);
        }
      })
      .catch(err => console.error("ä¿å­˜é…ç½®é”™è¯¯:", err));
    }

    // æ–°å¢å‡½æ•°ï¼šæ ¼å¼åŒ– JSON
    function formatConfig() {
      let configData = editor.getValue();
      try {
        let parsed = JSON.parse(configData);
        editor.setValue(JSON.stringify(parsed, null, 4));
      } catch(e) {
        alert("âŒ å½“å‰å†…å®¹ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼ï¼Œæ— æ³•æ ¼å¼åŒ–");
      }
    }

    function uploadConfig() {
      const fileInput = document.getElementById("upload-config");
      if(fileInput.files.length === 0) {
        alert("âŒ è¯·é€‰æ‹©ä¸€ä¸ªé…ç½®æ–‡ä»¶è¿›è¡Œä¸Šä¼ ã€‚");
        return;
      }
      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append('jsonFile', file);
      fetch('upload_json.php', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          alert("âœ… é…ç½®æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼");
          loadConfig();
        } else {
          alert("âŒ ä¸Šä¼ å¤±è´¥ï¼š" + data.error);
        }
      })
      .catch(err => console.error("ä¸Šä¼ é…ç½®é”™è¯¯:", err));
    }

    // Raw é“¾æ¥ç”Ÿæˆç›¸å…³
    function loadRawEndpoints() {
      // é€šè¿‡ endpoints_manager.php çš„ list æ¥å£åŠ è½½æ‰€æœ‰ endpoints keyï¼Œç”¨äº Raw é“¾æ¥ä¸‹æ‹‰èœå•
      fetch('endpoints_manager.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'list'})
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          let select = document.getElementById("raw-endpoint");
          select.innerHTML = '<option value="">ä¸æ›¿æ¢</option>';
          for(let key in data.endpoints) {
            let option = document.createElement("option");
            option.value = key;
            option.innerText = key;
            select.appendChild(option);
          }
        } else {
          console.error("åŠ è½½ Raw endpoints å¤±è´¥ï¼š" + data.error);
        }
      })
      .catch(err => console.error("åŠ è½½ Raw endpoints é”™è¯¯:", err));
    }

    function generateRawLink() {
      const rawPwd = document.getElementById("raw-password").value;
      if(!rawPwd) {
        alert("âŒ è¯·è¾“å…¥ Raw è®¿é—®å¯†ç ");
        return;
      }
      // å›ºå®šé…ç½®æ–‡ä»¶åä¸º config.jsonï¼Œå®Œæ•´ URL æ˜¾ç¤º
      let rawLink = "https://sing-box.200502.xyz/raw.php?pwd=" + encodeURIComponent(rawPwd) + "&file=config.json";
      const selectedEp = document.getElementById("raw-endpoint").value;
      if(selectedEp) {
        rawLink += "&ep=" + encodeURIComponent(selectedEp);
      }
      document.getElementById("raw-link-display").innerText = rawLink;
    }

    // Endpoints ç®¡ç†ç›¸å…³
    function loadEndpoints() {
      fetch('endpoints_manager.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'list'})
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          let tbody = document.querySelector("#endpoints-table tbody");
          tbody.innerHTML = "";
          for(let key in data.endpoints) {
            let tr = document.createElement("tr");
            
            let tdKey = document.createElement("td");
            tdKey.innerText = key;
            
            let tdContent = document.createElement("td");
            // åˆ›å»ºé¢„æ ¼å¼åŒ–çš„ä»£ç å—ï¼Œä½¿ç”¨ CodeMirror.runMode è¿›è¡Œé«˜äº®
            let pre = document.createElement("pre");
            pre.style.backgroundColor = "#f6f8fa";
            pre.style.padding = "10px";
            pre.style.borderRadius = "4px";
            pre.style.overflowX = "auto";
            let code = document.createElement("code");
            code.className = "json";
            let jsonText = JSON.stringify(data.endpoints[key], null, 4);
            CodeMirror.runMode(jsonText, "application/json", code);
            pre.appendChild(code);
            tdContent.appendChild(pre);
            
            let tdActions = document.createElement("td");
            let editBtn = document.createElement("button");
            editBtn.innerText = "ç¼–è¾‘";
            editBtn.className = "btn";
            editBtn.onclick = function() {
              document.getElementById("endpoint-key").value = key;
              document.getElementById("endpoint-content").value = JSON.stringify(data.endpoints[key], null, 4);
            };
            let deleteBtn = document.createElement("button");
            deleteBtn.innerText = "åˆ é™¤";
            deleteBtn.className = "btn";
            deleteBtn.onclick = function() {
              if(confirm("ç¡®è®¤åˆ é™¤ endpoints " + key + " å—ï¼Ÿ")) {
                deleteEndpoint(key);
              }
            };
            tdActions.appendChild(editBtn);
            tdActions.appendChild(deleteBtn);
            tr.appendChild(tdKey);
            tr.appendChild(tdContent);
            tr.appendChild(tdActions);
            tbody.appendChild(tr);
          }
        } else {
          alert("åŠ è½½ endpoints å¤±è´¥ï¼š" + data.error);
        }
      })
      .catch(err => console.error("åŠ è½½ endpoints é”™è¯¯:", err));
    }

    function saveEndpoint() {
      let key = document.getElementById("endpoint-key").value.trim();
      let content = document.getElementById("endpoint-content").value.trim();
      if(!key || !content) {
        alert("âŒ Key å’Œå†…å®¹ä¸èƒ½ä¸ºç©ºï¼");
        return;
      }
      let endpointData;
      try {
        endpointData = JSON.parse(content);
      } catch(e) {
        alert("âŒ Endpoints å†…å®¹ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼");
        return;
      }
      // ç»Ÿä¸€ä½¿ç”¨ update æ“ä½œï¼ˆè‹¥ key ä¸å­˜åœ¨åˆ™ç›¸å½“äºæ·»åŠ ï¼‰
      fetch('endpoints_manager.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'update', key: key, data: endpointData})
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          alert("âœ… Endpoints ä¿å­˜æˆåŠŸï¼");
          loadEndpoints();
          clearEndpointForm();
        } else {
          alert("âŒ ä¿å­˜å¤±è´¥ï¼š" + data.error);
        }
      })
      .catch(err => console.error("ä¿å­˜ endpoints é”™è¯¯:", err));
    }

    function deleteEndpoint(key) {
      fetch('endpoints_manager.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'delete', key: key})
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          alert("âœ… Endpoints åˆ é™¤æˆåŠŸï¼");
          loadEndpoints();
        } else {
          alert("âŒ åˆ é™¤å¤±è´¥ï¼š" + data.error);
        }
      })
      .catch(err => console.error("åˆ é™¤ endpoints é”™è¯¯:", err));
    }

    function clearEndpointForm() {
      document.getElementById("endpoint-key").value = "";
      document.getElementById("endpoint-content").value = "";
    }

    // å†å²ç‰ˆæœ¬ç®¡ç†ç›¸å…³
    function loadHistory() {
      fetch('get_history.php')
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          let tbody = document.querySelector("#history-table tbody");
          tbody.innerHTML = "";
          data.history.forEach(item => {
            let tr = document.createElement("tr");
            let tdFile = document.createElement("td");
            tdFile.innerText = item;
            let tdActions = document.createElement("td");
            let restoreBtn = document.createElement("button");
            restoreBtn.innerText = "æ¢å¤";
            restoreBtn.className = "btn";
            restoreBtn.onclick = function() {
              if(confirm("ç¡®è®¤æ¢å¤ " + item + " çš„ç‰ˆæœ¬å—ï¼Ÿ")) {
                restoreHistory(item);
              }
            };
            let deleteBtn = document.createElement("button");
            deleteBtn.innerText = "åˆ é™¤";
            deleteBtn.className = "btn";
            deleteBtn.onclick = function() {
              if(confirm("ç¡®è®¤åˆ é™¤å†å²ç‰ˆæœ¬ " + item + " å—ï¼Ÿ")) {
                deleteHistory(item);
              }
            };
            tdActions.appendChild(restoreBtn);
            tdActions.appendChild(deleteBtn);
            tr.appendChild(tdFile);
            tr.appendChild(tdActions);
            tbody.appendChild(tr);
          });
        } else {
          alert("åŠ è½½å†å²ç‰ˆæœ¬å¤±è´¥ï¼š" + data.error);
        }
      })
      .catch(err => console.error("åŠ è½½å†å²ç‰ˆæœ¬é”™è¯¯:", err));
    }

    function restoreHistory(fileName) {
      fetch('restore_history.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({file: fileName})
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          alert("âœ… é…ç½®å·²æ¢å¤ä¸º " + fileName);
          loadConfig();
          loadHistory();
        } else {
          alert("âŒ æ¢å¤å¤±è´¥ï¼š" + data.error);
        }
      })
      .catch(err => console.error("æ¢å¤å†å²ç‰ˆæœ¬é”™è¯¯:", err));
    }

    function deleteHistory(fileName) {
      fetch('delete_history.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({file: fileName})
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          alert("âœ… å†å²ç‰ˆæœ¬åˆ é™¤æˆåŠŸï¼");
          loadHistory();
        } else {
          alert("âŒ åˆ é™¤å¤±è´¥ï¼š" + data.error);
        }
      })
      .catch(err => console.error("åˆ é™¤å†å²ç‰ˆæœ¬é”™è¯¯:", err));
    }
  </script>
</body>
</html>
