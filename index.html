<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>🚀 Sing-Box 配置管理平台 🚀</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- CodeMirror CSS 和 JS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/codemirror.min.css">
  <!-- 引入 material-darker 主题 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/theme/material-darker.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/mode/javascript/javascript.min.js"></script>
  <!-- CodeMirror runMode addon for syntax highlighting in static mode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/addon/runmode/runmode.min.js"></script>
  <!-- 自定义 CSS 美化页面 -->
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: #f0f2f5;
      color: #333;
    }
    header {
      background: linear-gradient(90deg, #4CAF50, #66BB6A);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    header h1 {
      margin: 0;
      font-size: 2em;
    }
    .container {
      max-width: 1200px;
      margin: 30px auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .hidden {
      display: none;
    }
    .tabs {
      display: flex;
      border-bottom: 2px solid #ccc;
      margin-bottom: 20px;
    }
    .tab {
      padding: 12px 24px;
      cursor: pointer;
      background: #e0e0e0;
      margin-right: 2px;
      border-top-left-radius: 5px;
      border-top-right-radius: 5px;
      transition: background 0.3s;
    }
    .tab:hover {
      background: #d5d5d5;
    }
    .tab.active {
      background: white;
      border: 2px solid #ccc;
      border-bottom: none;
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    .btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px 0;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.3s;
      font-size: 1em;
    }
    .btn:hover {
      background: #45a049;
    }
    input[type="text"], input[type="password"], textarea, select {
      padding: 10px;
      width: 100%;
      box-sizing: border-box;
      margin: 5px 0 15px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
    }
    textarea {
      resize: vertical;
      min-height: 150px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 12px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    pre {
      margin: 0;
      font-family: "Courier New", Courier, monospace;
      font-size: 0.95em;
    }
    .raw-link {
      font-size: 1.1em;
      margin-top: 10px;
      background: #f9f9f9;
      padding: 10px;
      border: 1px dashed #ccc;
      word-break: break-all;
      border-radius: 4px;
    }
    /* 设置 CodeMirror 编辑器高度 */
    .CodeMirror {
      height: 500px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <header>
    <h1>🚀 Sing-Box 配置管理平台 🚀</h1>
  </header>
  <div class="container">
    <!-- 登录区域 -->
    <div id="login-section">
      <h2>🔒 请登录</h2>
      <input type="password" id="login-password" placeholder="请输入登录密码">
      <button class="btn" onclick="login()">登录</button>
    </div>
    <!-- 主管理区域 -->
    <div id="main-section" class="hidden">
      <!-- 标签导航 -->
      <div class="tabs">
        <div class="tab active" data-tab="config">📝 配置编辑</div>
        <div class="tab" data-tab="endpoints">🔌 Endpoints 管理</div>
        <div class="tab" data-tab="history">📜 历史版本管理</div>
      </div>
      <!-- 各标签对应的内容区域 -->
      <div id="config" class="section active">
        <h2>📝 配置编辑</h2>
        <!-- 配置编辑区域使用 CodeMirror 编辑器，支持格式化 -->
        <textarea id="config-editor" placeholder="加载配置中..."></textarea>
        <div style="margin-bottom: 10px;">
          <button class="btn" onclick="saveConfig()">💾 保存配置</button>
          <button class="btn" onclick="formatConfig()">🔧 格式化 JSON</button>
        </div>
        <input type="file" id="upload-config" accept=".json">
        <button class="btn" onclick="uploadConfig()">📤 上传配置文件</button>
        <hr>
        <h3>🔗 Raw 链接生成</h3>
        <p>请输入 Raw 访问密码：</p>
        <input type="password" id="raw-password" placeholder="Raw访问密码">
        <p>选择 Endpoints（可选）：</p>
        <select id="raw-endpoint">
          <option value="">不替换</option>
        </select>
        <button class="btn" onclick="generateRawLink()">生成 Raw 链接</button>
        <div id="raw-link-display" class="raw-link"></div>
      </div>
      <div id="endpoints" class="section">
        <h2>🔌 Endpoints 管理</h2>
        <button class="btn" onclick="loadEndpoints()">🔄 刷新列表</button>
        <table id="endpoints-table">
          <thead>
            <tr>
              <th>Key</th>
              <th>配置内容</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <!-- 由 JS 动态生成列表 -->
          </tbody>
        </table>
        <hr>
        <h3>➕ 添加 / 修改 Endpoints</h3>
        <p>Key: <input type="text" id="endpoint-key" placeholder="例如：default"></p>
        <p>Endpoints JSON 内容:</p>
        <textarea id="endpoint-content" placeholder='例如: [{"type": "wireguard", ...}]'></textarea>
        <button class="btn" onclick="saveEndpoint()">💾 保存 Endpoints</button>
        <button class="btn" onclick="clearEndpointForm()">🧹 清空</button>
      </div>
      <div id="history" class="section">
        <h2>📜 历史版本管理</h2>
        <button class="btn" onclick="loadHistory()">🔄 刷新历史列表</button>
        <table id="history-table">
          <thead>
            <tr>
              <th>文件名</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <!-- 由 JS 动态生成历史版本列表 -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- CodeMirror 与各功能 JS 脚本 -->
  <script>
    let editor;
    let currentConfig = "";
    // 切换标签页时，根据 tabId 切换内容，同时若切换到 endpoints 标签则自动加载 endpoints 列表，
    // 切换到配置编辑标签时则加载 Raw 下拉菜单（Endpoints列表），切换到历史版本管理则自动加载历史文件。
    function switchTab(tabId) {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');
      if (tabId === "endpoints") {
        loadEndpoints();
      } else if (tabId === "config") {
        loadRawEndpoints();
      } else if (tabId === "history") {
        loadHistory();
      }
    }

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        switchTab(this.getAttribute('data-tab'));
      });
    });

    function login() {
      const password = document.getElementById("login-password").value;
      fetch('login.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({password: password})
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          document.getElementById("login-section").classList.add('hidden');
          document.getElementById("main-section").classList.remove('hidden');
          loadConfig();
          loadRawEndpoints();
        } else {
          alert("❌ 登录失败，密码错误。");
        }
      })
      .catch(err => console.error("登录错误:", err));
    }

    function loadConfig() {
      fetch('get_config.php')
      .then(response => response.json())
      .then(data => {
        currentConfig = JSON.stringify(data, null, 4);
        if (!editor) {
          const textarea = document.getElementById("config-editor");
          textarea.value = currentConfig;
          editor = CodeMirror.fromTextArea(textarea, {
            mode: 'application/json',
            lineNumbers: true,
            matchBrackets: true,
            theme: 'material-darker',
            tabSize: 2,
            lineWrapping: true,
            viewportMargin: Infinity
          });
        } else {
          editor.setValue(currentConfig);
        }
      })
      .catch(err => console.error("加载配置错误:", err));
    }

    function saveConfig() {
      let configData = editor.getValue();
      try {
        JSON.parse(configData);
      } catch(e) {
        alert("❌ 配置内容不是有效的 JSON 格式");
        return;
      }
      fetch('save_json.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({json: configData})
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          alert("✅ 配置保存成功！");
          loadConfig();
        } else {
          alert("❌ 保存失败：" + data.error);
        }
      })
      .catch(err => console.error("保存配置错误:", err));
    }

    // 新增函数：格式化 JSON
    function formatConfig() {
      let configData = editor.getValue();
      try {
        let parsed = JSON.parse(configData);
        editor.setValue(JSON.stringify(parsed, null, 4));
      } catch(e) {
        alert("❌ 当前内容不是有效的 JSON 格式，无法格式化");
      }
    }

    function uploadConfig() {
      const fileInput = document.getElementById("upload-config");
      if(fileInput.files.length === 0) {
        alert("❌ 请选择一个配置文件进行上传。");
        return;
      }
      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append('jsonFile', file);
      fetch('upload_json.php', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          alert("✅ 配置文件上传成功！");
          loadConfig();
        } else {
          alert("❌ 上传失败：" + data.error);
        }
      })
      .catch(err => console.error("上传配置错误:", err));
    }

    // Raw 链接生成相关
    function loadRawEndpoints() {
      // 通过 endpoints_manager.php 的 list 接口加载所有 endpoints key，用于 Raw 链接下拉菜单
      fetch('endpoints_manager.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'list'})
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          let select = document.getElementById("raw-endpoint");
          select.innerHTML = '<option value="">不替换</option>';
          for(let key in data.endpoints) {
            let option = document.createElement("option");
            option.value = key;
            option.innerText = key;
            select.appendChild(option);
          }
        } else {
          console.error("加载 Raw endpoints 失败：" + data.error);
        }
      })
      .catch(err => console.error("加载 Raw endpoints 错误:", err));
    }

    function generateRawLink() {
      const rawPwd = document.getElementById("raw-password").value;
      if(!rawPwd) {
        alert("❌ 请输入 Raw 访问密码");
        return;
      }
      // 固定配置文件名为 config.json，完整 URL 显示
      let rawLink = "https://sing-box.200502.xyz/raw.php?pwd=" + encodeURIComponent(rawPwd) + "&file=config.json";
      const selectedEp = document.getElementById("raw-endpoint").value;
      if(selectedEp) {
        rawLink += "&ep=" + encodeURIComponent(selectedEp);
      }
      document.getElementById("raw-link-display").innerText = rawLink;
    }

    // Endpoints 管理相关
    function loadEndpoints() {
      fetch('endpoints_manager.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'list'})
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          let tbody = document.querySelector("#endpoints-table tbody");
          tbody.innerHTML = "";
          for(let key in data.endpoints) {
            let tr = document.createElement("tr");
            
            let tdKey = document.createElement("td");
            tdKey.innerText = key;
            
            let tdContent = document.createElement("td");
            // 创建预格式化的代码块，使用 CodeMirror.runMode 进行高亮
            let pre = document.createElement("pre");
            pre.style.backgroundColor = "#f6f8fa";
            pre.style.padding = "10px";
            pre.style.borderRadius = "4px";
            pre.style.overflowX = "auto";
            let code = document.createElement("code");
            code.className = "json";
            let jsonText = JSON.stringify(data.endpoints[key], null, 4);
            CodeMirror.runMode(jsonText, "application/json", code);
            pre.appendChild(code);
            tdContent.appendChild(pre);
            
            let tdActions = document.createElement("td");
            let editBtn = document.createElement("button");
            editBtn.innerText = "编辑";
            editBtn.className = "btn";
            editBtn.onclick = function() {
              document.getElementById("endpoint-key").value = key;
              document.getElementById("endpoint-content").value = JSON.stringify(data.endpoints[key], null, 4);
            };
            let deleteBtn = document.createElement("button");
            deleteBtn.innerText = "删除";
            deleteBtn.className = "btn";
            deleteBtn.onclick = function() {
              if(confirm("确认删除 endpoints " + key + " 吗？")) {
                deleteEndpoint(key);
              }
            };
            tdActions.appendChild(editBtn);
            tdActions.appendChild(deleteBtn);
            tr.appendChild(tdKey);
            tr.appendChild(tdContent);
            tr.appendChild(tdActions);
            tbody.appendChild(tr);
          }
        } else {
          alert("加载 endpoints 失败：" + data.error);
        }
      })
      .catch(err => console.error("加载 endpoints 错误:", err));
    }

    function saveEndpoint() {
      let key = document.getElementById("endpoint-key").value.trim();
      let content = document.getElementById("endpoint-content").value.trim();
      if(!key || !content) {
        alert("❌ Key 和内容不能为空！");
        return;
      }
      let endpointData;
      try {
        endpointData = JSON.parse(content);
      } catch(e) {
        alert("❌ Endpoints 内容不是有效的 JSON 格式");
        return;
      }
      // 统一使用 update 操作（若 key 不存在则相当于添加）
      fetch('endpoints_manager.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'update', key: key, data: endpointData})
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          alert("✅ Endpoints 保存成功！");
          loadEndpoints();
          clearEndpointForm();
        } else {
          alert("❌ 保存失败：" + data.error);
        }
      })
      .catch(err => console.error("保存 endpoints 错误:", err));
    }

    function deleteEndpoint(key) {
      fetch('endpoints_manager.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'delete', key: key})
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          alert("✅ Endpoints 删除成功！");
          loadEndpoints();
        } else {
          alert("❌ 删除失败：" + data.error);
        }
      })
      .catch(err => console.error("删除 endpoints 错误:", err));
    }

    function clearEndpointForm() {
      document.getElementById("endpoint-key").value = "";
      document.getElementById("endpoint-content").value = "";
    }

    // 历史版本管理相关
    function loadHistory() {
      fetch('get_history.php')
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          let tbody = document.querySelector("#history-table tbody");
          tbody.innerHTML = "";
          data.history.forEach(item => {
            let tr = document.createElement("tr");
            let tdFile = document.createElement("td");
            tdFile.innerText = item;
            let tdActions = document.createElement("td");
            let restoreBtn = document.createElement("button");
            restoreBtn.innerText = "恢复";
            restoreBtn.className = "btn";
            restoreBtn.onclick = function() {
              if(confirm("确认恢复 " + item + " 的版本吗？")) {
                restoreHistory(item);
              }
            };
            let deleteBtn = document.createElement("button");
            deleteBtn.innerText = "删除";
            deleteBtn.className = "btn";
            deleteBtn.onclick = function() {
              if(confirm("确认删除历史版本 " + item + " 吗？")) {
                deleteHistory(item);
              }
            };
            tdActions.appendChild(restoreBtn);
            tdActions.appendChild(deleteBtn);
            tr.appendChild(tdFile);
            tr.appendChild(tdActions);
            tbody.appendChild(tr);
          });
        } else {
          alert("加载历史版本失败：" + data.error);
        }
      })
      .catch(err => console.error("加载历史版本错误:", err));
    }

    function restoreHistory(fileName) {
      fetch('restore_history.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({file: fileName})
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          alert("✅ 配置已恢复为 " + fileName);
          loadConfig();
          loadHistory();
        } else {
          alert("❌ 恢复失败：" + data.error);
        }
      })
      .catch(err => console.error("恢复历史版本错误:", err));
    }

    function deleteHistory(fileName) {
      fetch('delete_history.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({file: fileName})
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          alert("✅ 历史版本删除成功！");
          loadHistory();
        } else {
          alert("❌ 删除失败：" + data.error);
        }
      })
      .catch(err => console.error("删除历史版本错误:", err));
    }
  </script>
</body>
</html>
